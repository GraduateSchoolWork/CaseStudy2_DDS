---
title: "DDS_CaseStudy_2"
output:
  html_document:
    toc: true
    toc_depth: 2
author: "Kevin Boyd"
date: "11/21/2021"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load Libraries
```{r, message=F}
library(tidyverse)
library(GGally)
library(cowplot)
library(class)
library(caret)
library(e1071)
library(reshape2)
library(stringr)
```


# Load and look at the data
```{r}
attrition.df <- read.csv("CaseStudy2-data.csv", header = T)
str(attrition.df)
noSalary <- read.csv("CaseStudy2CompSet(NoSalary).csv", header = T)
str(noSalary)
```


# Attrition EDA
## Attrition Dependent on Marital Status
```{r}
# divorce contribute to attrition
bar <- ggplot(attrition.df, aes(x=MaritalStatus, fill = MaritalStatus)) +
  geom_bar() +
  facet_wrap(~Attrition) +
  ggtitle("Attrition Dependent on Marital Status ") +
  xlab("Attrition") +
  ylab("Count")

# Yes Attrition
# make new data frames for married, divorced, and single
df1 <- attrition.df %>%
  filter(Attrition == "Yes")
df1length <- NROW(df1)
df1married <- length(grep("Married", df1$MaritalStatus))
df1divorced <- length(grep("Divorced", df1$MaritalStatus))
df1single <- length(grep("Single", df1$MaritalStatus))

Yes_df <- data.frame(MaritalStatus = c("Married","Divorced","Single"), 
                     Value = c(df1married,df1divorced,df1single))

plot1 <- ggplot(Yes_df, aes(x="", y=Value, fill=MaritalStatus)) +
  geom_bar(width = 1, stat = "identity") + xlab("") + ylab("") + ggtitle("Attrition: Yes")
pie1 <- plot1 + coord_polar("y", start=0)

# No Attrition
# make new data frames for married, divorced, and single
df2 <- attrition.df %>%
  filter(Attrition == "No")
df2length <- NROW(df2)
df2married <- length(grep("Married", df2$MaritalStatus))
df2divorced <- length(grep("Divorced", df2$MaritalStatus))
df2single <- length(grep("Single", df2$MaritalStatus))

No_df <- data.frame(MaritalStatus = c("Married","Divorced","Single"), 
                     Value = c(df2married,df2divorced,df2single))

plot2 <- ggplot(No_df, aes(x="", y=Value, fill=MaritalStatus)) +
  geom_bar(width = 1, stat = "identity") + xlab("") + ylab("") + ggtitle("Attrition: No")
pie2 <- plot2 + coord_polar("y", start=0)

piecharts <- plot_grid(pie2,pie1, ncol = 2,  labels = c("B","C"))
allplots <- plot_grid(bar,piecharts, nrow = 2, labels = "A")
allplots
```


## Monthly Income
```{r}
ggplot(attrition.df, aes(x=MonthlyIncome, fill = Attrition)) +
  geom_histogram() +
  ggtitle("Monthly Income Based on Attrition") +
  xlab("Monthly Income") +
  ylab("Count")
```


## Monthly Income Based on Job Role
```{r}
ggplot(attrition.df, aes(x=MonthlyIncome, fill = Attrition)) +
  geom_histogram() +
  facet_wrap(~JobRole) +
  ggtitle("Monthly Income Based on Job Role") +
  xlab("Monthly Income") +
  ylab("Count")
```

## Percentage of Attrition Based on Multiple Variables
```{r}
EDA1 <- ggplot(attrition.df, aes(x=RelationshipSatisfaction, fill = Attrition)) +
  geom_bar(position = "fill") +
  #facet_wrap(~JobRole) +
  ggtitle("Relationship Satisfaction") +
  ylab("% Count") + 
  scale_y_continuous(labels = scales::percent) + 
  theme(legend.position = "none")

EDA2 <- ggplot(attrition.df, aes(x=JobLevel, fill = Attrition)) +
  geom_bar(position = "fill") +
  #facet_wrap(~JobRole) +
  ggtitle("Job Level") +
  ylab("% Count") + 
  scale_y_continuous(labels = scales::percent) + 
  theme(legend.position = "none")

EDA3 <- ggplot(attrition.df, aes(x=JobSatisfaction, fill = Attrition)) +
  geom_bar(position = "fill") +
  ggtitle("Job Satisfaction") +
  ylab("% Count") + 
  scale_y_continuous(labels = scales::percent) + 
  theme(legend.position = "none")

EDA4 <- ggplot(attrition.df, aes(x=YearsWithCurrManager, fill = Attrition)) +
  geom_bar(position = "fill") +
  ggtitle("Years With Current Manager") +
  ylab("% Count") + 
  scale_y_continuous(labels = scales::percent) + 
  theme(legend.position = "none")

EDA5 <- ggplot(attrition.df, aes(x=YearsSinceLastPromotion, fill = Attrition)) +
  geom_bar(position = "fill") +
  ggtitle("Years Since Last Promotion") +
  ylab("% Count") + 
  scale_y_continuous(labels = scales::percent) + 
  theme(legend.position = "none")

EDA6 <- ggplot(attrition.df, aes(x=YearsAtCompany, fill = Attrition)) +
  geom_bar(position = "fill") +
  ggtitle("Years At Company") +
  ylab("% Count") + 
  scale_y_continuous(labels = scales::percent) + 
  theme(legend.position = "none")

EDA7 <- ggplot(attrition.df, aes(x=YearsInCurrentRole, fill = Attrition)) +
  geom_bar(position = "fill") +
  ggtitle("Years in Current Role") +
  ylab("% Count") + 
  scale_y_continuous(labels = scales::percent) + 
  theme(legend.position = "none")

EDA8 <- ggplot(attrition.df, aes(x=NumCompaniesWorked, fill = Attrition)) +
  geom_bar(position = "fill") +
  ggtitle("Companies Worked") +
  ylab("% Count") + 
  scale_y_continuous(labels = scales::percent) + 
  theme(legend.position = "none")

EDA9 <- ggplot(attrition.df, aes(x=MaritalStatus, fill = Attrition)) +
  geom_bar(position = "fill") +
  ggtitle("Marital Status") +
  ylab("% Count") + 
  scale_y_continuous(labels = scales::percent) + 
  theme(legend.position = "none")

EDA10 <- plot_grid(EDA1,EDA2,EDA3,EDA4,EDA5,EDA6,EDA7,EDA8,EDA9, ncol = 3, nrow = 3)
EDA10
```

## Scatter Plots with Continuous Variables
```{r}
EDA.A <- ggplot(attrition.df, aes(x=TotalWorkingYears, y=PercentSalaryHike, color = Attrition)) +
  geom_point() +
  ggtitle("Total Working Years vs Percent Salary Hike")

EDA.B <- ggplot(attrition.df, aes(x=YearsWithCurrManager, y=PercentSalaryHike, color = Attrition)) +
  geom_point() +
  ggtitle("Years With Current Manager vs Percent Salary Hike")

EDA.C <-ggplot(attrition.df, aes(x=YearsAtCompany, y=YearsInCurrentRole, color = Attrition)) +
  geom_point() +
  ggtitle("Years At Company vs Years In CurrentRole")

EDA.D <- ggplot(attrition.df, aes(x=Age, y=MonthlyIncome, color = Attrition)) +
  geom_point() +
  ggtitle("Age vs Monthly Income")

EDA.E <- ggplot(attrition.df, aes(x=Age, y=YearsSinceLastPromotion, color = Attrition)) +
  geom_point() +
  ggtitle("Age vs Job YearsSinceLastPromotion")

EDA.F <- ggplot(attrition.df, aes(x=Age, y=PercentSalaryHike, color = Attrition)) +
  geom_point() +
  ggtitle("Age vs Percent Salary Hike")

EDA.G <- plot_grid(EDA.A,EDA.B,EDA.C,EDA.D,EDA.E,EDA.F, ncol = 2, nrow = 3)
EDA.G
```

## GGpairs Plots
```{r, message=F}
ggpairs(attrition.df, columns = c(2,25,35,36,3), aes(color = Attrition))
```

## Attrition Analysis by Job Role
```{r}
ggplot(attrition.df, aes(x=Age, y=MonthlyIncome, color = Attrition)) +
  geom_point() +
  facet_wrap(~JobRole)
```



# Models for Attrition
## k-NN Model (Train and Test Sets)
Conclusion: This model does not have enough "Yes" attrition data to be able to use. Internal may prove more able to handle this skewed data.
```{r}
set.seed(9)
splitPerc <- .85
trainIndices <- sample(1:dim(attrition.df)[1],round(splitPerc * dim(attrition.df)[1]))
dfTrain <- attrition.df[trainIndices,]
dfTest <- attrition.df[-trainIndices,]
dfTrain <- na.omit(dfTrain)
dfTest <- na.omit(dfTest)

# 2:Age, 18:JobSatisfaction, 20:MontlyIncome, 25:PercentSalaryHike, 
# 30:TotalWorkingYears, 30:TotalworkingYears, 33:YearsAtCompany, 
# 34:YearsInCurrentRole, 35:YearsSinceLastPromotion, 36:YearsWithCurrManager

# knn model 
classifications <- knn(dfTrain[,c(2,35)], dfTest[,c(2,35)], dfTrain$Attrition, 
                       prob = TRUE, k = 10)
table(dfTest$Attrition,classifications)
confusionMatrix(table(dfTest$Attrition,classifications))
```

## Loop for many k
```{r}
# Loop for many k and the average of many training / test partition
iterations = 100
numks = 50

masterAcc = matrix(nrow = iterations, ncol = numks)

for(j in 1:iterations)
{
  accs = data.frame(accuracy = numeric(100), k = numeric(100))
  trainIndices = sample(1:dim(attrition.df)[1],round(splitPerc * dim(attrition.df)[1]))
  train = attrition.df[trainIndices,]
  test = attrition.df[-trainIndices,]
  train = na.omit(train)
  test = na.omit(test)
  for(i in 1:numks)
  {
    classifications = knn(train[,c(2,35)],test[,c(2,35)],train$Attrition, prob = TRUE, k = i)
    table(classifications,test$Attrition)
    CM = confusionMatrix(table(classifications,test$Attrition))
    masterAcc[j,i] = CM$overall[1]
  }
  
}

MeanAcc = colMeans(masterAcc)

plot(seq(1,numks,1),MeanAcc, type = "l", xlab = "k", ylab = "Mean Accuracy", main = "Mean Accuracy of k Values")
```

## Internal k-NN Model
```{r}
# Internal Model
classifications1 <- knn.cv(dfTrain[,c(2,35)],dfTrain$Attrition, k = 20)
confusionMatrix(table(classifications1,dfTrain$Attrition))
```


## Naive Bayes
```{r}
NBmodel <- naiveBayes(dfTrain[,c(24,20)],dfTrain$Attrition,laplace = 1)
table(predict(NBmodel,dfTest[,c(24,20)]),dfTest$Attrition)
confusionMatrix(table(predict(NBmodel,dfTest[,c(24,20)]),dfTest$Attrition))

NBmodel1 = naiveBayes(Attrition~.,data = dfTrain)
table(predict(NBmodel1,dfTest))
confusionMatrix(table(predict(NBmodel1,dfTest),dfTest$Attrition))
```


## New Dataframe for Multiple Varables in Models
```{r}
# Make new dataframe and make train and test sets
set.seed(9)
new.df <- attrition.df[,c(2,3,4,5,6,7,15,16,18,20,29,30,32,33,34,35)]
splitPerc <- .7
trainIndices <- sample(1:dim(new.df)[1],round(splitPerc * dim(new.df)[1]))
dfTrain1 <- new.df[trainIndices,]
dfTest1 <- new.df[-trainIndices,]
dfTrain1 <- na.omit(dfTrain1)
dfTest1 <- na.omit(dfTest1)
```

## Run Model with New Datframe
```{r}
# Naive Bayes Model for New Dataframe
new.dfmodel = naiveBayes(Attrition~.,data = dfTrain1)
confusionMatrix(table(predict(new.dfmodel,dfTest1),dfTest1$Attrition))
```


# Linear Regression
## Attrition Linear Regression
Not sure if this is actually correct to use for this kind of data
```{r}
# change attrition variable to numberic for use in linear regression model
attrition.lm <- attrition.df
attrition.lm$Attrition <- gsub("Yes", 1, attrition.lm$Attrition)
attrition.lm$Attrition <- gsub("No", 0, attrition.lm$Attrition)
attrition.lm$Attrition <- as.numeric(attrition.lm$Attrition)

# run model
attritionfit = lm(Attrition~Age*MonthlyIncome, data = attrition.lm)
attritionfit1 = lm(Attrition~Age+MonthlyIncome, data = attrition.lm)
attritionfit2 = lm(Attrition~MonthlyIncome, data = attrition.lm)
attritionfit3 = lm(Attrition~Age, data = attrition.lm)

# inormation about model
summary(attritionfit)
confint(attritionfit)
attritionfit$coefficients
hist(attritionfit$residuals, col = "blue", main = "Histogram of Residuals")
sqrt(mean(attritionfit$residuals^2))
sum((attritionfit$residuals)^2)
```


## Train and Test for Linear Regression Attrition
```{r}
set.seed(9)
splitPerc <- .8
trainIndices <- sample(1:dim(attrition.lm)[1],round(splitPerc * dim(attrition.lm)[1]))
dfTrain2 <- attrition.lm[trainIndices,]
dfTest2 <- attrition.lm[-trainIndices,]
dfTrain2 <- na.omit(dfTrain2)
dfTest2 <- na.omit(dfTest2)
```

```{r}
# Best LM model for Attrition
LR.fit <- lm(Attrition~Age*MonthlyIncome, data = dfTrain2)
summary(LR.fit)
LR.Preds <- predict(LR.fit, newdata = dfTest2)
as.data.frame(LR.Preds)

# Metrics for model
MSPE <- data.frame(Observed = dfTest2$Attrition, Predicted = LR.Preds)
MSPE$Resisdual <- MSPE$Observed - MSPE$Predicted
MSPE$SquaredResidual <- MSPE$Resisdual^2
MSPE
mean(MSPE$SquaredResidual)
RMSE <- mean((MSPE$Observed - MSPE$Predicted)^2) %>% sqrt()
RMSE
```



# Linear Regression for Salary
## Change Job Level to Character
```{r}
attrition.jl <- attrition.df
attrition.jl$JobLevel <- gsub(1, "1", attrition.jl$JobLevel)
attrition.jl$JobLevel <- gsub(2, "2", attrition.jl$JobLevel)
attrition.jl$JobLevel <- gsub(3, "3", attrition.jl$JobLevel)
attrition.jl$JobLevel <- gsub(4, "4", attrition.jl$JobLevel)
attrition.jl$JobLevel <- gsub(5, "5", attrition.jl$JobLevel)
attrition.jl$JobLevel <- as.character(attrition.jl$JobLevel)

# Job level model
JLModel_fit = lm(MonthlyIncome~JobLevel, data = attrition.jl)
summary(JLModel_fit)
preds <- predict(JLModel_fit)
hist(JLModel_fit$residuals, col = "blue", main = "Histogram of Residuals")
plot(JLModel_fit$fitted.values,JLModel_fit$residuals, main = "Plot of Residuals v. Fitted Values")
attrition.jl %>% ggplot(aes(x = JobLevel, y = MonthlyIncome)) + 
  geom_point() + 
  geom_line(data = attrition.jl, aes(x = JobLevel, y = preds, col = "red"))
```


## Predict Using Single Variable
```{r}
Model1_fit = lm(MonthlyIncome~JobLevel, data = attrition.df)
summary(Model1_fit)
hist(Model1_fit$residuals, col = "blue", main = "Histogram of Residuals")
SalaryPredict <- predict(Model1_fit, noSalary, interval = "confidence") 
SalaryPredict <- as.data.frame(SalaryPredict)
noSalary$MonthlyIncome <- SalaryPredict[,1]
noSalary %>% ggplot(aes(x = JobLevel, y = MonthlyIncome)) + geom_point() + geom_line(data = noSalary, aes(x = JobLevel, y = MonthlyIncome, col = "red"))
```


## Predict Using Exponential Variable (Squared)
```{r}
# Good Exponential Model 
attriton.df2 = attrition.df %>% mutate(JobLevel2 = (JobLevel^2))
fit = lm(MonthlyIncome~JobLevel+JobLevel2, attriton.df2)
summary(fit)
preds2 <- predict(fit)
hist(fit$residuals, col = "blue", main = "Histogram of Residuals")
plot(fit$fitted.values,fit$residuals, main = "Plot of Residuals v. Fitted Values")
attriton.df2 %>% ggplot(aes(x = JobLevel, y = MonthlyIncome)) + geom_point() + geom_line(data = attriton.df2, aes(x = JobLevel, y = preds, col = "red"))

noSalary <- noSalary %>% mutate(JobLevel2 = (JobLevel^2))
test2 <- predict(fit, noSalary, interval = "confidence") 
test2 <- as.data.frame(test2)
noSalary$Salary <- test2[,1]
noSalary %>% ggplot(aes(x = JobLevel, y = Salary)) + geom_point() + geom_line(data = noSalary, aes(x = JobLevel, y = Salary , col = "red"))
```


## Predict Using Exponential Variable (Cubed)
```{r}
# Adding extra exponential variable helped
attriton.df3 = attrition.df %>% mutate(JobLevel2 = (JobLevel^2), 
                                       JobLevel3 = (JobLevel^3))
fit2 = lm(MonthlyIncome~JobLevel+JobLevel2+JobLevel3, attriton.df3)
summary(fit2)
preds2 <- predict(fit2)
hist(fit2$residuals, col = "blue", main = "Histogram of Residuals")
plot(fit2$fitted.values,fit2$residuals, main = "Plot of Residuals v. Fitted Values")
attriton.df3 %>% ggplot(aes(x = JobLevel, y = MonthlyIncome)) + 
  geom_point() + 
  geom_line(data = attriton.df3, aes(x = JobLevel, y = preds2, col = "red"))


noSalary <- noSalary %>% mutate(JobLevel3 = (JobLevel^3))
test3 <- predict(fit2, noSalary, interval = "confidence") 
test3 <- as.data.frame(test3)
noSalary$Salary2 <- test3[,1]
noSalary %>% ggplot(aes(x = JobLevel, y = Salary2)) + 
  geom_point() + 
  geom_line(data = noSalary, aes(x = JobLevel, y = Salary2 , col = "red"))
```


## Predict Using Exponential Variable (4th Root)
```{r}
# Adding extra exponential variable hurt
attriton.df4 = attrition.df %>% mutate(JobLevel2 = (JobLevel^2), 
                                       JobLevel3 = (JobLevel^3), 
                                       JobLevel4 = (JobLevel^4))
fit3 = lm(MonthlyIncome~JobLevel+JobLevel2+JobLevel3+JobLevel4, attriton.df4)
summary(fit3)
preds3 <- predict(fit3)
hist(fit3$residuals, col = "blue", main = "Histogram of Residuals")
plot(fit3$fitted.values,fit3$residuals, main = "Plot of Residuals v. Fitted Values")
attriton.df4 %>% ggplot(aes(x = JobLevel, y = MonthlyIncome)) + 
  geom_point() + 
  geom_line(data = attriton.df4, aes(x = JobLevel, y = preds3, col = "red"))
```


## Mulitple Variable Linear Regression
```{r}
# best !!!
Model2_fit = lm(MonthlyIncome~Age+JobLevel+JobRole, data = dfTrain)
summary(Model2_fit)
preds <- predict(Model2_fit)

hist(Model2_fit$residuals, col = "blue", main = "Histogram of Residuals")

sqrt(sum((Model1_fit$residuals)^2))
sqrt(sum((Model2_fit$residuals)^2))

# better
Model2_fit = lm(MonthlyIncome~Age+JobLevel+JobRole+JobSatisfaction, data = dfTrain)
summary(Model2_fit)


Model2_Preds = predict(Model2_fit, newdata = dfTest)
as.data.frame(Model2_Preds)

MSPE = data.frame(Observed = dfTest$MonthlyIncome, Predicted = Model2_Preds)
MSPE$Resisdual = MSPE$Observed - MSPE$Predicted
MSPE$SquaredResidual = MSPE$Resisdual^2
MSPE
mean(MSPE$SquaredResidual)
RMSE <- mean((MSPE$Observed - MSPE$Predicted)^2) %>% sqrt()
RMSE


```
